#!/usr/bin/env bash
set -e
set -x

# parameter $1 is the project list file generated by the baseline_history.sh script
export project_revisions=`cat ${1}`
export repo_name=${2}
export repo_init_tag=${3}
export repo_submodules=${4}
export gitignore_file=${5}

export gitrepo_project_original="scars"
export gitrepo_project_submodule="scars"

#initialize repo
if [ ! -e ${repo_name} ] ; then
    git clone --recursive ssh://git@dtdkcphlx0231.md-man.biz:7998/${gitrepo_project_submodule}/${repo_name}.git
    cd ${repo_name}
    git reset --hard ${repo_init_tag}

    export GIT_AUTHOR_DATE="11/11/70 11:11 AM"
    export GIT_COMMITTER_DATE="11/11/70 11:11 AM"

    test "${gitignore_file}x" != "x" && test -e ${gitignore_file} && cp ${gitignore_file} ./.gitignore

    git add -A .
    git status

    git commit -m "$repo_init_tag" --allow-empty --amend --reset-author
    git tag -a -m $(git tag -l --format '%(contents)' ${repo_init_tag}) ${repo_name}/${repo_init_tag}/${repo_init_tag}

    unset GIT_AUTHOR_DATE
    unset GIT_COMMITTER_DATE

    git reset --hard ${repo_name}/${repo_init_tag}/${repo_init_tag}
    git clean -xffd
    pwd
    # we are still in the root repo
else
    echo "Already cloned and initialized - skip "
    git fetch -ap
    pwd
    cd ${repo_name}
fi


for project_revision in ${project_revisions}; do
    ccm_project_name=`echo ${project_revision} | awk -F"@@@" '{print $1}' | awk -F"~" '{print $1}'`

    repo_convert_rev_tag=`echo ${project_revision} | awk -F"@@@" '{print $1}' | awk -F"~" '{print $2}'`
    ccm_baseline_obj_this=$(ccm query "has_project_in_baseline('${ccm_project_name}~$(echo ${repo_convert_rev_tag} | sed -e 's/xxx/ /g'):project:1') and release='$(ccm query "name='${ccm_project_name}' and version='$(echo ${repo_convert_rev_tag} | sed -e 's/xxx/ /g')' and type='project'" -u -f "%release")'" -u -f "%objectname" | head -1 )
    ccm_component_release=`ccm attr -show release "${ccm_project_name}~$(echo ${repo_convert_rev_tag} | sed -e 's/xxx/ /g'):project:1" | sed -e 's/ //g'`

    if [ "${ccm_baseline_obj_this}X" != "X" ]; then
        ccm_baseline_status_this=`ccm attr -show status "${ccm_baseline_obj_this}" |  cut -c1-3 `
    else
        ccm_baseline_status_this=`ccm attr -show status "${ccm_project_name}~$(echo ${repo_convert_rev_tag} | sed -e 's/xxx/ /g'):project:1" |  sed -e 's/ //g' |  cut -c1-3`
    fi

    repo_convert_rev_tag_wcomponent_wstatus="${ccm_project_name}/${repo_convert_rev_tag}_${ccm_baseline_status_this}"

    if [ `git describe ${repo_convert_rev_tag_wcomponent_wstatus}` ] ; then
      continue
    fi

    git fetch --tags

    # Get the right content
    if [ `git describe ${repo_convert_rev_tag}`  ] ; then
        # we do have the correct 'content' tag checkout it out
        git reset --hard ${repo_convert_rev_tag}
    else
        # we do not have the 'content' tag available - investigate its history if it exists ( e.g. missing in repo )
        ./baseline_history_get_root.sh "${ccm_project_name}~$(echo ${repo_convert_rev_tag} | sed -e 's/xxx/ /g')"
        exit 1
    fi

    git clean -xffd

    repo_baseline_rev_tag=`echo ${project_revision} | awk -F"@@@" '{print $2}' | awk -F"~" '{print $2}'`
    ccm_baseline_obj_baselineproj=$(ccm query "has_project_in_baseline('${ccm_project_name}~$(echo ${repo_baseline_rev_tag} | sed -e 's/xxx/ /g'):project:1') and release='$(ccm query "name='${ccm_project_name}' and version='$(echo ${repo_baseline_rev_tag} | sed -e 's/xxx/ /g')' and type='project'" -u -f "%release")'" -u -f "%objectname" | head -1 )
    if [ "${repo_baseline_rev_tag}" == "init" ]; then
        repo_baseline_rev_tag_wcomponent_wstatus="${repo_name}/${repo_init_tag}/${repo_init_tag}"
    else
        #ccm_baseline_component_release=`ccm attr -show release "${ccm_project_name}~$(echo ${repo_baseline_rev_tag} | sed -e 's/xxx/ /g'):project:1" |  sed -e 's/ //g'`
        if [ "${ccm_baseline_obj_baselineproj}X" != "X" ]; then
            ccm_baseline_status_baseline=`ccm attr -show status "${ccm_baseline_obj_baselineproj}" |  cut -c1-3 `
        else
            ccm_baseline_status_baseline=`ccm attr -show status "${ccm_project_name}~$(echo ${repo_baseline_rev_tag} | sed -e 's/xxx/ /g'):project:1" |  sed -e 's/ //g' |  cut -c1-3`
        fi
        repo_baseline_rev_tag_wcomponent_wstatus="${ccm_project_name}/${repo_baseline_rev_tag}_${ccm_baseline_status_baseline}"
    fi

    # Move the workarea pointer to the 'baseline' tag
    git reset --mixed ${repo_baseline_rev_tag_wcomponent_wstatus}
    git checkout HEAD .gitignore
    git status

    for repo_submodule in ${repo_submodules}; do
        repo_submodule_rev=`ccm query "hierarchy_project_members('${ccm_project_name}~$(echo ${repo_convert_rev_tag} | sed -e 's/xxx/ /g'):project:1',none) and name ='${repo_submodule}'" -u -f "%version" | sed -e 's/ /xxx/g'`
        if [ "${repo_submodule_rev}X" == "X" ] ; then
            echo "The submodule does not exit as a project - skip"
            continue
        fi
        git checkout HEAD .gitmodules || echo ".gitmodules does not exist in current revision"
        if [ ! `git checkout HEAD ${repo_submodule}` ] ; then
                git rm -rf ${repo_submodule} || rm -rf ${repo_submodule}
                git submodule add --force ssh://git@dtdkcphlx0231.md-man.biz:7998/${gitrepo_project_submodule}/${repo_submodule}.git
        fi
        git submodule update --init --recursive

        cd ${repo_submodule}

        git fetch --tags

        if [ `git describe ${repo_convert_rev_tag_wcomponent_wstatus}` ] ; then
            # we already have the correct tag, so just set it and move on..
            git checkout ${repo_submodule_rev}
            git clean -xffd
            repo_submodule_rev=""
            cd -
            continue
        fi

        repo_submodule_rev_wcomponent_wstatus=$(git tag | grep .*/.*/${repo_submodule_rev}_[dprtis][eueenq][lblsta]$ || echo )

        if [ `git describe ${repo_submodule_rev_wcomponent_wstatus}`  ] ; then
            # we do have the correct 'content' tag checkout it out
            git checkout ${repo_submodule_rev_wcomponent_wstatus}
            git clean -xffd
        else
            # we do not have the 'content' tag available - investgate its root
            cd $(dirname $0)
            ./baseline_history_get_root.sh "${repo_submodule}~$(echo ${repo_submodule_rev} | sed -e 's/xxx/ /g')"
            exit 1
        fi

        git tag -f -a -m "Please see tag in master repo for info: ${repo_convert_rev_tag_wcomponent_wstatus}" ${repo_convert_rev_tag_wcomponent_wstatus}

        git push origin -f --tag ${repo_convert_rev_tag_wcomponent_wstatus}

        repo_submodule_rev=""
        cd -

    done
    git status
    git add -A .
    #git status

    export GIT_AUTHOR_DATE=`ccm properties -f "%{create_time[dateformat='yyyy-MM-dd HH:MM:SS']}" "${ccm_project_name}~$(echo ${repo_convert_rev_tag} | sed -e 's/xxx/ /g'):project:1"`
    export GIT_COMMITTER_DATE=${GIT_AUTHOR_DATE}
    ccm_component_release=`ccm attr -show release "${ccm_project_name}~$(echo ${repo_convert_rev_tag} | sed -e 's/xxx/ /g'):project:1"`

    git commit -C ${repo_convert_rev_tag} --reset-author || ( echo "Empty commit.." )

    if [ "${ccm_baseline_obj_this}X" != "X" ]; then
        echo >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        echo "Baseline information:"                             >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        ccm baseline -show info -v "${ccm_baseline_obj_this}" > ./tag_meta_data.txt

        echo >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        echo "Project baseline:"                             >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        ccm query "is_baseline_project_of('${ccm_project_name}~$(echo ${repo_convert_rev_tag} | sed -e 's/xxx/ /g'):project:1')" -f "%displayname" >> ./tag_meta_data.txt || echo "  <none>" >> ./tag_meta_data.txt
        echo >> ./tag_meta_data.txt

        echo >> ./tag_meta_data.txt
        echo "---------------------------------------------------------">> ./tag_meta_data.txt
        echo "Master Change Requests (MCR):" >> ./tag_meta_data.txt
        echo "---------------------------------------------------------">> ./tag_meta_data.txt
        ccm query "has_associatedImpl(has_associated_task(is_dirty_task_in_baseline_of('${ccm_baseline_obj_this}')))" -u -f "%displayname %resolver %release %problem_synopsis" >> ./tag_meta_data.txt || echo "<none>" >> ./tag_meta_data.txt
        echo >> ./tag_meta_data.txt

        echo >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        echo "Fully integrated Implementation Change Requests(ICR):"     >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        ccm baseline -show fully_included_change_requests -groupby "Release: %release"  -f "%displayname %resolver %release %problem_synopsis" "${ccm_baseline_obj_this}" >> ./tag_meta_data.txt  || echo "<none>" >> ./tag_meta_data.txt
        echo >> ./tag_meta_data.txt

        echo >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        echo "Partially integrated Implementation Change Requests(ICR):" >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        ccm baseline -show fully_included_change_requests -groupby "Release: %release" -f "%displayname %resolver %release %problem_synopsis" "${ccm_baseline_obj_this}" >> ./tag_meta_data.txt  || echo "<none>" >> ./tag_meta_data.txt
        echo >> ./tag_meta_data.txt

        echo >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        echo "Tasks integrated in baseline:"                             >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        ccm baseline -show tasks -f "%displayname %{create_time[dateformat='yyyy-M-dd HH:MM:SS']} %resolver %status %release %task_synopsis" "${ccm_baseline_obj_this}" >> ./tag_meta_data.txt || echo "<none>" >> ./tag_meta_data.txt
        echo >> ./tag_meta_data.txt

        echo >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        echo "Tasks integrated in baseline (verbosed):"                  >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
#        ccm task -sh info @ >> ./tag_meta_data.txt || echo "<none>" >> ./tag_meta_data.txt
        ccm task -sh info -v @ >> ./tag_meta_data.txt || echo "<none>" >> ./tag_meta_data.txt

    else
        echo "---------------------------------------------------------">> ./tag_meta_data.txt
        echo "NO BASELINE OBJECT ASSOCIATED WITH THIS PROJECT REVISION" >> ./tag_meta_data.txt
        echo "---------------------------------------------------------">> ./tag_meta_data.txt
        echo >> ./tag_meta_data.txt

        echo >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        echo "Project baseline:"                             >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        ccm query "is_baseline_project_of('${ccm_project_name}~$(echo ${repo_convert_rev_tag} | sed -e 's/xxx/ /g'):project:1')" -f "%displayname"  >> ./tag_meta_data.txt || echo "  <none>" >> ./tag_meta_data.txt
        echo >> ./tag_meta_data.txt

        echo >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        echo "Master Change Requests (MCR):"                             >> ./tag_meta_data.txt
        echo "---------------------------------------------------------" >> ./tag_meta_data.txt
        ccm query "has_associatedImpl(has_associated_task(is_task_in_folder_of(is_folder_in_rp_of('${ccm_project_name}~$(echo ${repo_convert_rev_tag} | sed -e 's/xxx/ /g'):project:1'))))" -f "%displayname %resolver %release %problem_synopsis" >> ./tag_meta_data.txt  || echo "<none>" >> ./tag_meta_data.txt
        echo >> ./tag_meta_data.txt

        echo "---------------------------------------------------------">> ./tag_meta_data.txt
        echo "Related/Integrated Implementation Change Requests(ICR):" >> ./tag_meta_data.txt
        echo "---------------------------------------------------------">> ./tag_meta_data.txt
        ccm query "has_associated_task(is_task_in_folder_of(is_folder_in_rp_of('${ccm_project_name}~$(echo ${repo_convert_rev_tag} | sed -e 's/xxx/ /g'):project:1')))" -f "%displayname %resolver %release %problem_synopsis"  >> ./tag_meta_data.txt  || echo "<none>" >> ./tag_meta_data.txt
        echo >> ./tag_meta_data.txt

        echo "---------------------------------------------------------">> ./tag_meta_data.txt
        echo "Tasks integrated in project:" >> ./tag_meta_data.txt
        echo "---------------------------------------------------------">> ./tag_meta_data.txt
        ccm query "is_task_in_folder_of(is_folder_in_rp_of('${ccm_project_name}~$(echo ${repo_convert_rev_tag} | sed -e 's/xxx/ /g'):project:1'))" -f "%displayname %{create_time[dateformat='yyyy-M-dd HH:MM:SS']} %resolver %status %release %task_synopsis"  >> ./tag_meta_data.txt || echo "<none>" >> ./tag_meta_data.txt
        echo >> ./tag_meta_data.txt

        echo >> ./tag_meta_data.txt
        echo "---------------------------------------------------------">> ./tag_meta_data.txt
        echo "Tasks integrated in project (verbosed):" >> ./tag_meta_data.txt
        echo "---------------------------------------------------------">> ./tag_meta_data.txt
#        ccm task -sh info @ >> ./tag_meta_data.txt || echo "<none>" >> ./tag_meta_data.txt
        ccm task -sh info -v @ >> ./tag_meta_data.txt || echo "<none>" >> ./tag_meta_data.txt
    fi

    git tag -a -F ./tag_meta_data.txt ${repo_convert_rev_tag_wcomponent_wstatus}

    rm -f ./tag_meta_data.txt

    unset GIT_AUTHOR_DATE
    unset GIT_COMMITTER_DATE
    unset repo_convert_rev_tag_wcomponent_wstatus


#    git push origin -f --tag ${repo_convert_rev_tag_wcomponent_wstatus}

    echo "============================================================================"
    echo " NEXT "
    echo "============================================================================"

done

